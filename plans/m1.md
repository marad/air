# Milestone 1: Implementation Plan
**Podstawowa funkcjonalność - "Hello World z pliku"**

## Overview
This milestone delivers the basic end-to-end flow: reading a markdown file with YAML frontmatter and sending it to Vertex AI. The goal is to get a working CLI tool that can process template files.

**Success Criteria**: `./air template.md` reads a markdown file, sends it to Vertex AI, and displays the response.

---

## Current State Analysis

### What We Have (PoC)
- ✅ Working `callVertexAI()` function that sends prompts to Vertex AI
- ✅ Basic error handling for missing env vars
- ✅ Hardcoded prompt ("Hello World")
- ✅ Basic response printing
- ✅ Go module setup with required dependencies

### What's Missing
- ❌ CLI argument parsing (no file input)
- ❌ File reading logic
- ❌ YAML frontmatter parsing
- ❌ `.env` file loading
- ❌ Separation of config from content
- ❌ Proper error handling for file operations

---

## Task Breakdown

### Task 1: CLI - czytanie pliku
**Estimated effort**: 30 minutes

**Changes to `main.go`**:
```go
func main() {
    // Add argument validation
    if len(os.Args) < 2 {
        fmt.Fprintf(os.Stderr, "Usage: %s <template_file>\n", os.Args[0])
        os.Exit(1)
    }
    
    templateFile := os.Args[1]
    
    // Read file contents
    content, err := os.ReadFile(templateFile)
    if err != nil {
        fmt.Fprintf(os.Stderr, "Error reading file %s: %v\n", templateFile, err)
        os.Exit(1)
    }
    
    // TODO: Parse frontmatter and content
}
```

**Testing**:
- Test with valid file: `./air test.md`
- Test with non-existent file: `./air missing.md` (should show clear error)
- Test with no arguments: `./air` (should show usage)
- Test with directory instead of file (should error gracefully)

**Acceptance Criteria**:
- [ ] CLI accepts filename as first argument
- [ ] File contents are read into memory
- [ ] Clear error message for missing files
- [ ] Usage message displayed when no arguments
- [ ] Exit code 1 on errors, 0 on success

---

### Task 2: Parsowanie YAML frontmatter
**Estimated effort**: 1 hour

**Dependencies**: Add YAML parser
```bash
go get gopkg.in/yaml.v3
```

**Add to `main.go`**:
```go
import "gopkg.in/yaml.v3"

type Config struct {
    // Fields will expand in Milestone 2
    // For now, just parse and ignore
}

func parseFrontmatter(content []byte) (Config, string, error) {
    // Split by "---" delimiters
    // First "---" starts frontmatter
    // Second "---" ends frontmatter
    // Everything after is markdown content
    
    var config Config
    lines := string(content)
    
    // Check if file starts with "---"
    if !strings.HasPrefix(lines, "---\n") {
        // No frontmatter, entire content is markdown
        return config, lines, nil
    }
    
    // Find second "---"
    parts := strings.SplitN(lines[4:], "\n---\n", 2)
    if len(parts) < 2 {
        return config, "", fmt.Errorf("invalid frontmatter: missing closing ---")
    }
    
    // Parse YAML
    err := yaml.Unmarshal([]byte(parts[0]), &config)
    if err != nil {
        return config, "", fmt.Errorf("failed to parse YAML: %w", err)
    }
    
    // Return config and markdown content
    return config, strings.TrimSpace(parts[1]), nil
}
```

**Test cases to create**:
1. `test_templates/no_frontmatter.md` - Just markdown content
2. `test_templates/with_frontmatter.md` - Valid YAML + content
3. `test_templates/invalid_yaml.md` - Malformed YAML (should error)
4. `test_templates/unclosed_frontmatter.md` - Only one `---` (should error)

**Example test file** (`test_templates/with_frontmatter.md`):
```markdown
---
temperature: 0.7
---

Write a haiku about Go programming.
```

**Acceptance Criteria**:
- [ ] Successfully extracts YAML between `---` delimiters
- [ ] Returns markdown content without frontmatter
- [ ] Handles files without frontmatter (treats entire file as content)
- [ ] Clear error for malformed YAML
- [ ] Clear error for unclosed frontmatter

---

### Task 3: Ładowanie .env
**Estimated effort**: 45 minutes

**Dependencies**: Add .env parser
```bash
go get github.com/joho/godotenv
```

**Add to `main.go`**:
```go
import "github.com/joho/godotenv"

func loadEnv() {
    // Try to load .env from current directory
    err := godotenv.Load()
    if err != nil {
        // Don't fail if .env doesn't exist, just log
        // This is graceful - env vars might already be set
        if !os.IsNotExist(err) {
            fmt.Fprintf(os.Stderr, "Warning: error loading .env file: %v\n", err)
        }
    }
}

func main() {
    // Load .env FIRST, before anything else
    loadEnv()
    
    // ... rest of main
}
```

**Create example `.env`**:
```
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_CLOUD_LOCATION=europe-west1
```

**Testing**:
- Test with `.env` file present
- Test without `.env` file (should work if env vars already set)
- Test with malformed `.env` (should show warning but continue)

**Acceptance Criteria**:
- [ ] `.env` file loaded on startup
- [ ] Environment variables set correctly
- [ ] Graceful handling when `.env` doesn't exist
- [ ] Warning (not error) for malformed `.env`
- [ ] Works even if env vars already set system-wide

---

### Task 4: Integracja z AI
**Estimated effort**: 30 minutes

**Changes to `main.go`**:
```go
func main() {
    loadEnv()
    
    if len(os.Args) < 2 {
        fmt.Fprintf(os.Stderr, "Usage: %s <template_file>\n", os.Args[0])
        os.Exit(1)
    }
    
    // Read file
    templateFile := os.Args[1]
    content, err := os.ReadFile(templateFile)
    if err != nil {
        fmt.Fprintf(os.Stderr, "Error reading file: %v\n", err)
        os.Exit(1)
    }
    
    // Parse frontmatter
    config, markdown, err := parseFrontmatter(content)
    if err != nil {
        fmt.Fprintf(os.Stderr, "Error parsing template: %v\n", err)
        os.Exit(1)
    }
    _ = config // Will use in Milestone 2
    
    // Call AI with markdown content
    ctx := context.Background()
    result, err := callVertexAI(ctx, markdown)
    if err != nil {
        fmt.Fprintf(os.Stderr, "Error calling AI: %v\n", err)
        os.Exit(1)
    }
    
    // Print result
    fmt.Println(result)
}
```

**Test API error scenarios**:
- Missing `GOOGLE_CLOUD_PROJECT` env var
- Invalid project ID
- Network errors (simulated)
- Empty response from model

**Acceptance Criteria**:
- [ ] Markdown content (without frontmatter) sent to Vertex AI
- [ ] API errors handled gracefully with clear messages
- [ ] Exit code 1 on API errors
- [ ] Error messages provide context (which step failed)

---

### Task 5: Wyświetlanie odpowiedzi
**Estimated effort**: 15 minutes

**Changes to `main.go`**:
```go
// Print result
fmt.Println(result)
```

This is mostly done, but ensure:
- Output goes to stdout (not stderr)
- No extra formatting/decoration (just raw response)
- Newline at end of output

**For Milestone 2+**, we might add:
- JSON pretty-printing
- Color coding (optional)
- Streaming output (future)

**Acceptance Criteria**:
- [ ] AI response printed to stdout
- [ ] Clean output (no extra decorations)
- [ ] Proper newline handling
- [ ] Works well with shell redirection: `./air template.md > output.txt`

---

## Integration & Testing Plan

### End-to-End Test Scenario
1. Create test template: `examples/hello.md`
```markdown
---
# Config section (empty for now, will use in M2)
---

Write a short greeting in Polish.
```

2. Ensure `.env` exists with valid project ID

3. Build and run:
```bash
make build
./air examples/hello.md
```

4. Expected output: AI-generated greeting in Polish

### Error Handling Test Matrix
| Scenario | Expected Behavior | Exit Code |
|----------|------------------|-----------|
| No arguments | Show usage message | 1 |
| File not found | Clear error message | 1 |
| Invalid YAML | Parse error with context | 1 |
| Missing env var | Clear error about GOOGLE_CLOUD_PROJECT | 1 |
| API error | Error with API context | 1 |
| Success | AI response to stdout | 0 |

### Files to Create
- `examples/` directory
  - `hello.md` - Simple greeting prompt
  - `haiku.md` - Creative writing prompt
  - `no_frontmatter.md` - Test without YAML
- `.env.example` - Template for users to copy
- `test_templates/` directory (for unit tests)
  - Various frontmatter test cases

---

## Code Organization (for this milestone)

```
air/
├── main.go                 # All code here for M1
├── go.mod                 
├── go.sum
├── .env                    # Gitignored
├── .env.example            # NEW - Template
├── Makefile
├── README.md
├── ROADMAP.md
├── AGENTS.md
├── examples/               # NEW - Example templates
│   ├── hello.md
│   ├── haiku.md
│   └── no_frontmatter.md
└── plans/                  # NEW - This file
    └── m1.md
```

**Note**: Refactoring into packages happens in Milestone 5. For M1, keep everything in `main.go` to move fast.

---

## Dependencies to Add

```bash
go get gopkg.in/yaml.v3
go get github.com/joho/godotenv
```

Update `go.mod`:
```go
module consistency

go 1.21

require (
    cloud.google.com/go/aiplatform v1.x.x
    google.golang.org/genproto/googleapis/ai/... v0.x.x
    gopkg.in/yaml.v3 v3.0.1                      // NEW
    github.com/joho/godotenv v1.5.1              // NEW
)
```

---

## Risks & Mitigations

### Risk 1: YAML parsing edge cases
**Mitigation**: Create comprehensive test templates covering:
- No frontmatter
- Empty frontmatter
- Invalid YAML syntax
- Unclosed delimiters
- Special characters in content

### Risk 2: Environment variable conflicts
**Mitigation**: 
- Document precedence: `.env` file loads first, but doesn't override existing env vars
- Use `godotenv.Load()` not `godotenv.Overload()`

### Risk 3: File encoding issues
**Mitigation**:
- Assume UTF-8 encoding
- Add note in docs about file encoding requirements
- Test with files containing non-ASCII characters

---

## Definition of Done

Milestone 1 is complete when:
- [ ] All 5 tasks implemented and tested
- [ ] End-to-end flow works: `./air template.md`
- [ ] Error handling covers all identified scenarios
- [ ] Example templates created and tested
- [ ] `.env.example` file created
- [ ] README updated with basic usage
- [ ] Code builds without warnings: `make build`
- [ ] Manual testing passed for all test scenarios
- [ ] Ready to demo to stakeholders

---

## Next Steps (Milestone 2 Preview)

Once M1 is complete, Milestone 2 will add:
- Reading temperature, topP, maxTokens from YAML
- Configurable safety settings
- Model selection via YAML frontmatter

The `Config` struct created in M1 Task 2 will be extended to support these fields.

---

## Time Estimate

Total estimated effort: **3-4 hours**

- Task 1: 30 min
- Task 2: 1 hour
- Task 3: 45 min
- Task 4: 30 min
- Task 5: 15 min
- Integration & testing: 1 hour
- Documentation: 30 min

**Target completion**: Single development session

---

## Notes

- Keep code simple and in `main.go` for this milestone
- Focus on getting working functionality, not perfect code
- Detailed refactoring comes in Milestone 5
- YAML config struct is minimal now, will expand in M2
- Prioritize clear error messages over fancy features
