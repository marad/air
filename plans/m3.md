# Milestone 3: Implementation Plan
**Templating - "Składanie promptów z kawałków"**

## Overview
This milestone adds templating capabilities to AIR, enabling users to build complex prompts from reusable components. Users will be able to include external files, use placeholders with variable substitution, and pass variables through multiple mechanisms (CLI flags, environment variables, YAML frontmatter).

**Success Criteria**: Users can compose prompts from multiple template files with dynamic content through placeholder replacement, with variables provided via CLI, environment, or YAML frontmatter.

---

## Current State Analysis

### What We Have (After M2)
- ✅ Full end-to-end flow with AI generation
- ✅ YAML frontmatter parsing infrastructure
- ✅ Config struct with generation parameters, model selection, safety settings
- ✅ Clean file reading and template processing pipeline
- ✅ Error handling for parsing and validation
- ✅ Single-file template execution

### What's Missing
- ❌ File inclusion mechanism
- ❌ Circular include detection
- ❌ Placeholder syntax parsing
- ❌ Variable resolution from multiple sources
- ❌ CLI flag parsing for variables
- ❌ Variable precedence handling (CLI > frontmatter > env)
- ❌ Default values for placeholders

---

## Design Decisions

### File Inclusion Syntax
**Chosen syntax**: `{{include "path/to/file.md"}}`

**Rationale**:
- Clear and explicit
- Consistent with placeholder syntax
- Easy to parse with regex
- Supports both relative and absolute paths

**Behavior**:
- Relative paths resolved from the directory of the file containing the include
- Absolute paths used as-is
- Included files processed recursively (can contain includes and placeholders)
- Circular includes detected and rejected with clear error

### Placeholder Syntax
**Chosen syntax**: `{{variable_name}}` or `{{variable_name|default_value}}`

**Rationale**:
- Common in templating systems (Mustache-like)
- Easy to parse
- Optional default value for graceful degradation

**Examples**:
```markdown
Hello {{name}}!
Your order number is {{order_id}}.
Status: {{status|pending}}
```

### Variable Sources & Precedence
**Order** (highest to lowest priority):
1. CLI flags: `--var name=value`
2. YAML frontmatter: `variables:` section
3. Environment variables: `$NAME` (uppercased)

**Rationale**:
- CLI overrides everything (explicit user intent)
- Frontmatter provides template-specific defaults
- Environment variables for system-wide configuration

---

## Task Breakdown

### Task 9: File Inclusion
**Estimated effort**: 2 hours

**Goal**: Implement `{{include "path"}}` syntax with circular dependency detection.

**Add to `main.go`**:

```go
import (
    "path/filepath"
    "regexp"
)

// Track processed files to detect circular includes
type inclusionContext struct {
    visited map[string]bool
    baseDir string
}

func newInclusionContext(initialFile string) *inclusionContext {
    return &inclusionContext{
        visited: make(map[string]bool),
        baseDir: filepath.Dir(initialFile),
    }
}

var includePattern = regexp.MustCompile(`\{\{include\s+"([^"]+)"\}\}`)

func processIncludes(content string, ctx *inclusionContext) (string, error) {
    result := content
    
    for {
        matches := includePattern.FindStringSubmatch(result)
        if matches == nil {
            // No more includes found
            break
        }
        
        includePath := matches[1]
        fullMatch := matches[0]
        
        // Resolve path (relative to current file's directory)
        resolvedPath := includePath
        if !filepath.IsAbs(includePath) {
            resolvedPath = filepath.Join(ctx.baseDir, includePath)
        }
        
        // Normalize path for circular detection
        absPath, err := filepath.Abs(resolvedPath)
        if err != nil {
            return "", fmt.Errorf("resolving include path %s: %w", includePath, err)
        }
        
        // Check for circular includes
        if ctx.visited[absPath] {
            return "", fmt.Errorf("circular include detected: %s", includePath)
        }
        
        // Mark as visited
        ctx.visited[absPath] = true
        
        // Read included file
        includedContent, err := os.ReadFile(absPath)
        if err != nil {
            return "", fmt.Errorf("reading included file %s: %w", includePath, err)
        }
        
        // Recursively process includes in the included file
        // Update baseDir for nested includes
        oldBaseDir := ctx.baseDir
        ctx.baseDir = filepath.Dir(absPath)
        
        processedContent, err := processIncludes(string(includedContent), ctx)
        if err != nil {
            return "", err
        }
        
        ctx.baseDir = oldBaseDir
        
        // Replace the include directive with processed content
        result = strings.Replace(result, fullMatch, processedContent, 1)
        
        // Unmark for other branches (allows same file in different paths)
        delete(ctx.visited, absPath)
    }
    
    return result, nil
}
```

**Test cases to create** (`test_templates/includes/`):

1. **test_templates/includes/base.md** - Simple include
```markdown
---
temperature: 0.5
---

{{include "fragments/greeting.md"}}

Write a story about AI.
```

2. **test_templates/includes/fragments/greeting.md**
```markdown
Hello! I'm an AI assistant.
```

3. **test_templates/includes/nested.md** - Nested includes
```markdown
{{include "fragments/header.md"}}
{{include "fragments/body.md"}}
```

4. **test_templates/includes/fragments/header.md**
```markdown
# Document Header
{{include "title.md"}}
```

5. **test_templates/includes/fragments/title.md**
```markdown
**Important Document**
```

6. **test_templates/includes/fragments/body.md**
```markdown
This is the main content.
```

7. **test_templates/includes/circular_a.md** - Circular dependency (should error)
```markdown
{{include "circular_b.md"}}
```

8. **test_templates/includes/circular_b.md**
```markdown
{{include "circular_a.md"}}
```

9. **test_templates/includes/missing.md** - Missing file (should error)
```markdown
{{include "nonexistent.md"}}
```

**Integration into main flow**:
```go
func main() {
    loadEnv()
    
    if len(os.Args) < 2 {
        fatalf("Usage: %s <template_file>", os.Args[0])
    }
    
    templateFile := os.Args[1]
    
    content, err := os.ReadFile(templateFile)
    if err != nil {
        fatalf("Error reading file %s: %v", templateFile, err)
    }
    
    // NEW: Process includes BEFORE parsing frontmatter
    ctx := newInclusionContext(templateFile)
    contentWithIncludes, err := processIncludes(string(content), ctx)
    if err != nil {
        fatalf("Error processing includes: %v", err)
    }
    
    // Continue with existing flow
    config, markdown, err := parseFrontmatter([]byte(contentWithIncludes))
    if err != nil {
        fatalf("Error parsing template: %v", err)
    }
    
    // ... rest of main
}
```

**Acceptance Criteria**:
- [ ] `{{include "path"}}` syntax correctly includes file contents
- [ ] Relative paths resolved from current file's directory
- [ ] Absolute paths work correctly
- [ ] Nested includes work (includes can contain includes)
- [ ] Circular includes detected and rejected with clear error
- [ ] Missing included files produce clear error messages
- [ ] Include processing happens before frontmatter parsing
- [ ] Manual testing with all test templates succeeds

---

### Task 10: Placeholder Replacement
**Estimated effort**: 1.5 hours

**Goal**: Implement `{{variable}}` and `{{variable|default}}` syntax for placeholder replacement.

**Add to `main.go`**:

```go
var placeholderPattern = regexp.MustCompile(`\{\{([a-zA-Z_][a-zA-Z0-9_]*?)(?:\|([^}]*))?\}\}`)

func replacePlaceholders(content string, variables map[string]string) (string, error) {
    var missing []string
    
    result := placeholderPattern.ReplaceAllStringFunc(content, func(match string) string {
        submatches := placeholderPattern.FindStringSubmatch(match)
        if len(submatches) < 2 {
            return match
        }
        
        varName := submatches[1]
        defaultValue := ""
        if len(submatches) >= 3 {
            defaultValue = submatches[2]
        }
        
        // Try to resolve variable
        if value, ok := variables[varName]; ok {
            return value
        }
        
        // Use default if provided
        if defaultValue != "" {
            return defaultValue
        }
        
        // No value and no default - track as missing
        missing = append(missing, varName)
        return match // Keep placeholder as-is for error reporting
    })
    
    if len(missing) > 0 {
        return "", fmt.Errorf("undefined variables without defaults: %v", missing)
    }
    
    return result, nil
}
```

**Test cases to create** (`test_templates/placeholders/`):

1. **test_templates/placeholders/basic.md**
```markdown
---
temperature: 0.5
variables:
  name: Alice
  task: painting
---

Write a story about {{name}} learning {{task}}.
```

2. **test_templates/placeholders/with_defaults.md**
```markdown
---
---

Hello {{name|User}}!
Your status is: {{status|active}}
Task: {{task|none assigned}}
```

3. **test_templates/placeholders/missing_var.md** - Should error
```markdown
---
---

Hello {{undefined_variable}}!
```

4. **test_templates/placeholders/mixed.md**
```markdown
---
variables:
  author: Bob
---

Written by: {{author}}
Date: {{date|today}}
Version: {{version}}
```

**Acceptance Criteria**:
- [ ] `{{variable}}` syntax replaced with variable value
- [ ] `{{variable|default}}` uses default when variable undefined
- [ ] Variables from frontmatter resolved correctly
- [ ] Missing variables without defaults produce clear error
- [ ] Variable names support letters, numbers, underscores (must start with letter/underscore)
- [ ] Placeholder replacement happens after include processing
- [ ] Manual testing with all test templates succeeds

---

### Task 11: Variable Resolution & CLI Flags
**Estimated effort**: 2 hours

**Goal**: Accept variables via CLI flags, environment variables, and YAML frontmatter with correct precedence.

**Add to `Config` struct**:
```go
type Config struct {
    // ... existing fields ...
    
    // Variables for placeholder replacement
    Variables map[string]string `yaml:"variables"`
}
```

**Add CLI flag parsing**:
```go
import "flag"

func parseVarFlags(args []string) (map[string]string, []string, error) {
    vars := make(map[string]string)
    remaining := []string{}
    
    i := 0
    for i < len(args) {
        arg := args[i]
        
        if arg == "--var" || arg == "-v" {
            if i+1 >= len(args) {
                return nil, nil, fmt.Errorf("--var requires an argument")
            }
            
            i++
            varDef := args[i]
            
            // Parse "key=value"
            parts := strings.SplitN(varDef, "=", 2)
            if len(parts) != 2 {
                return nil, nil, fmt.Errorf("invalid --var format: %s (expected key=value)", varDef)
            }
            
            vars[parts[0]] = parts[1]
        } else {
            remaining = append(remaining, arg)
        }
        
        i++
    }
    
    return vars, remaining, nil
}

func getEnvVariables() map[string]string {
    vars := make(map[string]string)
    
    // Get all environment variables
    for _, env := range os.Environ() {
        parts := strings.SplitN(env, "=", 2)
        if len(parts) == 2 {
            // Store with original case for now
            vars[parts[0]] = parts[1]
        }
    }
    
    return vars
}

func mergeVariables(cliVars, frontmatterVars, envVars map[string]string) map[string]string {
    // Priority: CLI > frontmatter > env
    result := make(map[string]string)
    
    // Start with env vars (lowest priority)
    for k, v := range envVars {
        result[k] = v
    }
    
    // Override with frontmatter vars
    for k, v := range frontmatterVars {
        result[k] = v
    }
    
    // Override with CLI vars (highest priority)
    for k, v := range cliVars {
        result[k] = v
    }
    
    return result
}
```

**Update `main()` function**:
```go
func main() {
    loadEnv()
    
    // Parse CLI flags for variables
    cliVars, args, err := parseVarFlags(os.Args[1:])
    if err != nil {
        fatalf("Error parsing flags: %v", err)
    }
    
    if len(args) < 1 {
        fatalf("Usage: %s [--var key=value ...] <template_file>", os.Args[0])
    }
    
    templateFile := args[0]
    
    // Read template
    content, err := os.ReadFile(templateFile)
    if err != nil {
        fatalf("Error reading file %s: %v", templateFile, err)
    }
    
    // Process includes
    ctx := newInclusionContext(templateFile)
    contentWithIncludes, err := processIncludes(string(content), ctx)
    if err != nil {
        fatalf("Error processing includes: %v", err)
    }
    
    // Parse frontmatter
    config, markdown, err := parseFrontmatter([]byte(contentWithIncludes))
    if err != nil {
        fatalf("Error parsing template: %v", err)
    }
    
    if err := config.Validate(); err != nil {
        fatalf("Invalid configuration: %v", err)
    }
    
    // Merge variables (CLI > frontmatter > env)
    envVars := getEnvVariables()
    variables := mergeVariables(cliVars, config.Variables, envVars)
    
    // Replace placeholders
    finalMarkdown, err := replacePlaceholders(markdown, variables)
    if err != nil {
        fatalf("Error replacing placeholders: %v", err)
    }
    
    // Call AI
    ctx := context.Background()
    result, err := callVertexAI(ctx, config, finalMarkdown)
    if err != nil {
        fatalf("Error calling AI: %v", err)
    }
    
    fmt.Println(result)
}
```

**Test cases to create**:

1. **CLI variable override** - Run with: `./air template.md --var name=Charlie`
```markdown
---
variables:
  name: Alice
---

Hello {{name}}!
```
Expected output should use "Charlie"

2. **Environment variable usage**
```bash
export AUTHOR=Bob
./air template.md
```

Template (`test_templates/variables/env_var.md`):
```markdown
---
---

Written by: {{AUTHOR|Unknown}}
```

3. **Precedence test**
```bash
export STATUS=env_value
./air template.md --var STATUS=cli_value
```

Template (`test_templates/variables/precedence.md`):
```markdown
---
variables:
  STATUS: frontmatter_value
---

Status: {{STATUS}}
```
Expected: "cli_value" (CLI wins)

4. **Multiple CLI variables**
```bash
./air template.md --var name=Alice --var age=30 --var city=Warsaw
```

**Acceptance Criteria**:
- [ ] `--var key=value` CLI flag parsing works
- [ ] Multiple `--var` flags supported
- [ ] Variables from YAML frontmatter loaded into Config
- [ ] Environment variables accessible in templates
- [ ] Precedence order enforced: CLI > frontmatter > env
- [ ] Invalid `--var` format produces clear error
- [ ] Usage message updated to show `--var` option
- [ ] Manual testing with all scenarios succeeds

---

## Integration & Testing Plan

### End-to-End Test Scenarios

**Scenario 1: Multi-file template composition**

**File structure**:
```
examples/
  email_template.md
  fragments/
    header.md
    signature.md
```

**examples/email_template.md**:
```markdown
---
temperature: 0.3
variables:
  recipient: Customer
  company: OpenAI
---

{{include "fragments/header.md"}}

Write a professional email about our new product launch.

{{include "fragments/signature.md"}}
```

**examples/fragments/header.md**:
```markdown
To: {{recipient}}
From: {{company}} Team

---
```

**examples/fragments/signature.md**:
```markdown

---
Best regards,
The {{company}} Team
```

**Run**:
```bash
./air examples/email_template.md --var recipient="John Doe" --var company="Acme Corp"
```

**Expected**: Complete email template with all includes processed and variables replaced.

---

**Scenario 2: Reusable prompt components**

**File structure**:
```
examples/
  analysis_task.md
  fragments/
    analysis_instructions.md
    output_format.md
```

**examples/analysis_task.md**:
```markdown
---
temperature: 0.0
responseMimeType: application/json
---

{{include "fragments/analysis_instructions.md"}}

Text to analyze: "{{input_text}}"

{{include "fragments/output_format.md"}}
```

**examples/fragments/analysis_instructions.md**:
```markdown
Analyze the following text for sentiment, key topics, and tone.
```

**examples/fragments/output_format.md**:
```markdown
Return JSON with fields:
- sentiment: positive/negative/neutral
- topics: array of strings
- tone: professional/casual/technical
```

**Run**:
```bash
./air examples/analysis_task.md --var input_text="This product is amazing!"
```

---

**Scenario 3: Environment-based configuration**

```bash
export AI_CONTEXT="technical documentation"
export TARGET_AUDIENCE="software developers"

./air examples/content_generation.md --var topic="API design"
```

**examples/content_generation.md**:
```markdown
---
model: gemini-1.5-pro-002
temperature: 0.7
---

Create {{AI_CONTEXT|content}} about {{topic}} for {{TARGET_AUDIENCE|general audience}}.
```

---

### Error Handling Test Matrix

| Scenario | Expected Behavior | Exit Code |
|----------|------------------|-----------|
| Valid template with includes | Success | 0 |
| Circular include | Error: "circular include detected: X" | 1 |
| Missing included file | Error: "reading included file X: no such file" | 1 |
| Undefined variable (no default) | Error: "undefined variables: [X, Y]" | 1 |
| Invalid --var format | Error: "invalid --var format: X" | 1 |
| --var without value | Error: "--var requires an argument" | 1 |
| Valid template with defaults | Success (uses defaults) | 0 |
| Nested includes with variables | Success | 0 |

---

## Example Templates to Create

Create in `examples/` directory:

### 1. **examples/reusable_prompt.md**
```markdown
---
temperature: 0.7
variables:
  topic: programming
  style: professional
---

{{include "fragments/instructions.md"}}

Write about: {{topic}}
Style: {{style}}

{{include "fragments/constraints.md"}}
```

### 2. **examples/fragments/instructions.md**
```markdown
You are a helpful AI assistant specializing in technical writing.
```

### 3. **examples/fragments/constraints.md**
```markdown
Keep the response concise and well-structured.
Use examples where appropriate.
```

### 4. **examples/dynamic_analysis.md**
```markdown
---
temperature: 0.0
responseMimeType: application/json
---

Analyze this {{content_type|text}}: "{{content}}"

Focus on: {{focus_areas|general analysis}}
```

**Usage**:
```bash
./air examples/dynamic_analysis.md \
  --var content_type="code snippet" \
  --var content="def hello(): print('hi')" \
  --var focus_areas="code quality and style"
```

---

## Code Organization (for this milestone)

```
air/
├── main.go                        # All code still here (refactor in M5)
│                                  # NEW functions:
│                                  # - processIncludes()
│                                  # - replacePlaceholders()
│                                  # - parseVarFlags()
│                                  # - getEnvVariables()
│                                  # - mergeVariables()
│                                  # - inclusionContext struct
├── go.mod                 
├── go.sum
├── .env
├── .env.example
├── Makefile
├── README.md
├── ROADMAP.md
├── AGENTS.md
├── examples/                      # EXPANDED
│   ├── hello.md
│   ├── haiku.md
│   ├── no_frontmatter.md
│   ├── creative_story.md
│   ├── deterministic_analysis.md
│   ├── safe_content.md
│   ├── email_template.md         # NEW
│   ├── analysis_task.md          # NEW
│   ├── content_generation.md     # NEW
│   ├── reusable_prompt.md        # NEW
│   ├── dynamic_analysis.md       # NEW
│   └── fragments/                # NEW
│       ├── header.md
│       ├── signature.md
│       ├── instructions.md
│       ├── constraints.md
│       ├── analysis_instructions.md
│       └── output_format.md
├── test_templates/                # EXPANDED
│   ├── ... (existing M1/M2 files)
│   ├── includes/                 # NEW
│   │   ├── base.md
│   │   ├── nested.md
│   │   ├── circular_a.md
│   │   ├── circular_b.md
│   │   ├── missing.md
│   │   └── fragments/
│   │       ├── greeting.md
│   │       ├── header.md
│   │       ├── title.md
│   │       └── body.md
│   ├── placeholders/             # NEW
│   │   ├── basic.md
│   │   ├── with_defaults.md
│   │   ├── missing_var.md
│   │   └── mixed.md
│   └── variables/                # NEW
│       ├── env_var.md
│       ├── precedence.md
│       └── cli_vars.md
├── docs/
│   └── config-reference.md       # UPDATE - Add variables section
└── plans/
    ├── m1.md
    ├── m2.md
    └── m3.md                     # This file
```

---

## Documentation Updates

### Update `README.md`

Add "Templating Features" section:

```markdown
## Templating Features

### File Inclusion

Include external files in your templates:

\`\`\`markdown
{{include "fragments/header.md"}}
Main content here
{{include "fragments/footer.md"}}
\`\`\`

Includes support:
- Relative paths (resolved from current file's directory)
- Absolute paths
- Nested includes (includes can contain includes)
- Circular dependency detection

### Variables and Placeholders

Use placeholders with default values:

\`\`\`markdown
Hello {{name|User}}!
Your task: {{task}}
\`\`\`

Variables can be provided via:

1. **CLI flags** (highest priority):
   \`\`\`bash
   ./air template.md --var name=Alice --var task=coding
   \`\`\`

2. **YAML frontmatter**:
   \`\`\`yaml
   ---
   variables:
     name: Bob
     task: writing
   ---
   \`\`\`

3. **Environment variables** (lowest priority):
   \`\`\`bash
   export NAME=Charlie
   ./air template.md
   \`\`\`

Default values: Use `{{variable|default_value}}` syntax.
```

### Update `docs/config-reference.md`

Add "Variables Section":

```markdown
## Variables

### variables (map, optional)
Define variables for placeholder replacement.

Example:
\`\`\`yaml
---
variables:
  author: Alice
  version: "1.0"
  status: draft
---

Document by {{author}}, version {{version}}
Status: {{status|unknown}}
\`\`\`

### Variable Sources

Variables are resolved in this order (highest to lowest priority):

1. **CLI flags**: `--var name=value`
2. **Frontmatter**: `variables:` section in YAML
3. **Environment variables**: System environment

### Placeholder Syntax

- Basic: `{{variable_name}}`
- With default: `{{variable_name|default_value}}`

Variable names:
- Must start with letter or underscore
- Can contain letters, numbers, underscores
- Case-sensitive

### File Inclusion

Include external files:

\`\`\`markdown
{{include "path/to/file.md"}}
\`\`\`

Features:
- Relative paths resolved from current file's directory
- Absolute paths supported
- Nested includes allowed
- Circular includes detected and rejected
- Included files can contain includes and placeholders
\`\`\`
```

---

## Definition of Done

Milestone 3 is complete when:
- [ ] Task 9: File inclusion implemented and tested
- [ ] Task 10: Placeholder replacement implemented and tested
- [ ] Task 11: Variable resolution from CLI/env/frontmatter working
- [ ] Circular include detection working
- [ ] All test templates created and tested
- [ ] Error handling for all edge cases implemented
- [ ] Example templates with reusable components created
- [ ] README updated with templating documentation
- [ ] Configuration reference updated
- [ ] Code builds without warnings: `make build`
- [ ] Manual end-to-end testing passed for all scenarios
- [ ] Backward compatibility maintained (old templates still work)
- [ ] Ready to use for complex multi-file prompt engineering

---

## Next Steps (Milestone 4 Preview)

Once M3 is complete, Milestone 4 will add:
- JSON Schema support in YAML frontmatter
- Schema-to-protobuf conversion for `responseSchema` field
- Structured output validation
- Pretty-printing of JSON responses

This enables type-safe structured outputs from AI models.

---

## Time Estimate

Total estimated effort: **5-6 hours**

- Task 9 (File inclusion): 2 hours
- Task 10 (Placeholder replacement): 1.5 hours
- Task 11 (Variable resolution): 2 hours
- Integration & testing: 1 hour
- Documentation: 30 min

**Target completion**: 1-2 development sessions

---

## Risks & Mitigations

### Risk 1: Path traversal security
**Problem**: Malicious templates could include files outside project directory
**Mitigation**: 
- For M3: Document this as expected behavior (user controls templates)
- For production: Could add `--include-root` flag to restrict includes
- Consider in M5 if needed for production use

### Risk 2: Infinite recursion in includes
**Problem**: Complex circular dependencies might not be caught
**Mitigation**:
- Track visited files with absolute paths
- Clear visited tracking between independent branches
- Add maximum include depth limit if needed (e.g., 50 levels)

### Risk 3: Variable name collisions
**Problem**: Environment has many variables, might accidentally shadow
**Mitigation**:
- Case-sensitive matching (avoid accidental matches)
- Document precedence clearly
- Consider prefix convention (e.g., `AIR_*`) in docs
- Show warning for shadowed variables? (could add in M5)

### Risk 4: Large included files
**Problem**: Including large files could cause memory issues
**Mitigation**:
- For M3: Accept as user responsibility
- Files are read entirely already, includes don't change this
- Could add size limits in M5 if needed

### Risk 5: Complex regex edge cases
**Problem**: Placeholder regex might match unintended patterns
**Mitigation**:
- Use strict pattern: `{{variable_name|default}}`
- Require valid identifier format for variable names
- Extensive test coverage for edge cases
- Consider escaping mechanism in future (`\{{` for literal)

---

## Notes

- Keep all code in `main.go` for this milestone (refactor in M5)
- Process includes BEFORE frontmatter parsing (includes might contain frontmatter)
- Process placeholders AFTER frontmatter parsing (need config for variables)
- Order: read file → includes → parse frontmatter → placeholders → AI call
- Variable precedence: CLI > frontmatter > environment
- Circular include detection must handle complex scenarios (A→B→C→A)
- Included files are processed recursively (can contain includes and placeholders)
- Default values in placeholders are optional but recommended
- Clear error messages crucial for debugging template composition

---

## Testing Checklist

Before marking M3 complete, manually test:

- [ ] Simple file inclusion works
- [ ] Nested includes (3+ levels deep) work
- [ ] Circular include (A→B→A) detected and rejected
- [ ] Missing included file shows clear error with path
- [ ] Basic placeholder replacement works
- [ ] Placeholders with default values work
- [ ] Undefined placeholder without default shows clear error
- [ ] Variables from CLI flags work
- [ ] Variables from frontmatter work
- [ ] Variables from environment work
- [ ] CLI variables override frontmatter variables
- [ ] CLI variables override environment variables
- [ ] Frontmatter variables override environment variables
- [ ] Multiple `--var` flags work correctly
- [ ] Invalid `--var` format shows clear error
- [ ] Complex multi-file template with variables works
- [ ] Relative paths in includes resolved correctly
- [ ] Absolute paths in includes work
- [ ] Templates without templating features still work (backward compatibility)
- [ ] All example templates run successfully
- [ ] Build process clean: no warnings, no errors

---

## Implementation Order Recommendation

1. **Start with Task 9 (File inclusion)** - Foundation for composition
   - Implement basic include without circular detection
   - Add circular detection
   - Test thoroughly with various nesting scenarios

2. **Then Task 10 (Placeholder replacement)** - Core templating feature
   - Implement basic `{{var}}` syntax
   - Add default value support `{{var|default}}`
   - Test with various edge cases

3. **Finally Task 11 (Variable resolution)** - Ties everything together
   - Add CLI flag parsing
   - Implement variable merging with precedence
   - Test all three variable sources and their interactions

4. **Integration testing** - Ensure all pieces work together
   - Create complex examples using all features
   - Test combinations (includes + variables, nested includes + placeholders, etc.)

---

## Advanced Use Cases (Future Considerations)

Not in scope for M3, but worth documenting for future:

- **Conditional includes**: `{{include "file.md" if condition}}`
- **Loops**: `{{for item in list}}...{{end}}`
- **Filters**: `{{variable|uppercase}}`
- **Escaping**: `\{{not_a_placeholder}}`
- **Include with variable path**: `{{include "{{folder}}/file.md"}}`
- **Variable scoping**: Local variables per included file

These could be considered for M6 or later milestones if user demand exists.
